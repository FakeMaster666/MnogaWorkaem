<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Batteries & Experiments</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    h2 { margin-top: 30px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background: #eee; }
    tr:hover { background: #f9f9f9; cursor: pointer; }
    #plotArea { margin-top: 20px; }
    .hidden { display: none; }
    #backBtn { margin: 10px 0; }
  </style>
</head>
<body>
  <h1>Battery Experiments Viewer</h1>

  <div id="batteriesView">
    <h2>Список батарей</h2>
    <table>
      <thead>
        <tr><th>ID</th><th>Name</th><th>Chemistry</th><th>Capacity</th><th>Voltage</th></tr>
      </thead>
      <tbody id="batTableBody"></tbody>
    </table>
  </div>

  <div id="experimentsView" class="hidden">
    <button id="backBtn">← Назад к батареям</button>
    <h2>Эксперименты</h2>
    <table>
      <thead>
        <tr><th>ID</th><th>Format</th><th>Date</th><th>Duration</th><th>Notes</th></tr>
      </thead>
      <tbody id="expTableBody"></tbody>
    </table>
  </div>

  <div id="plotConfig" class="hidden">
    <h2>Конфигурация графика</h2>
    <label>Ось X:
      <select id="xSelect"></select>
    </label>
    <div id="yCheckboxes"></div>
    <button id="plotBtn">Построить график</button>
  </div>

  <form id="uploadForm" action="/upload" method="post" enctype="multipart/form-data"
      style="position: fixed; top: 20px; right: 20px; background: #fff; padding: 10px; border: 1px solid #000;">
  <input type="file" name="file" required>
  <button type="submit">Загрузить файл</button>
</form>

  <div id="message"></div>

  <div id="plotArea"></div>

<script>
const batTableBody = document.getElementById("batTableBody");
const expTableBody = document.getElementById("expTableBody");
const batteriesView = document.getElementById("batteriesView");
const experimentsView = document.getElementById("experimentsView");
const backBtn = document.getElementById("backBtn");
const plotConfig = document.getElementById("plotConfig");
const xSelect = document.getElementById("xSelect");
const yCheckboxes = document.getElementById("yCheckboxes");
const plotBtn = document.getElementById("plotBtn");
const plotArea = document.getElementById("plotArea");


let selectedBattery = null;
let selectedExperiment = null;

// --- helpers
function escapeHtml(text) {
  return text === null || text === undefined ? "" :
    text.toString().replace(/[&<>"']/g, m => ({
      "&":"&amp;", "<":"&lt;", ">":"&gt;", "\"":"&quot;", "'":"&#039;"
    }[m]));
}





const uploadForm = document.getElementById('uploadForm');
const fileInput = uploadForm.querySelector('input[type="file"]');

fileInput.addEventListener('change', () => {
  const fileName = fileInput.files[0]?.name || '';
  console.log('Выбран файл:', fileName); // можно отображать рядом с кнопкой
});

uploadForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!fileInput.files.length) return;
   const formData = new FormData();
  formData.append('file', fileInput.files[0]);
   try {
    const resp = await fetch('/upload', { method: 'POST', body: formData });
    const result = await resp.json();
    alert(`Файл ${result.filename} загружен!`);
  } catch (err) {
    alert('Ошибка загрузки: ' + err.message);
  }
});





// --- load batteries
async function loadBatteries() {
  const resp = await fetch("/api/batteries");
  if (!resp.ok) { batTableBody.innerHTML = "<tr><td colspan=5>Ошибка API</td></tr>"; return; }
  const arr = await resp.json();
  batTableBody.innerHTML = "";
  arr.forEach(b => {
    const tr = document.createElement("tr");
    tr.dataset.id = b.id;
    tr.innerHTML = `
      <td>${b.id}</td>
      <td>${escapeHtml(b.name||"")}</td>
      <td>${escapeHtml(b.chemistry||"")}</td>
      <td>${b.capacity ?? ""}</td>
      <td>${b.voltage ?? ""}</td>`;
    batTableBody.appendChild(tr);
  });
}

// --- load experiments for battery
async function loadExperiments(batteryId) {
  const resp = await fetch(`/api/experiments?battery_id=${batteryId}`);
  if (!resp.ok) { expTableBody.innerHTML = "<tr><td colspan=5>Ошибка API</td></tr>"; return; }
  const arr = await resp.json();
  expTableBody.innerHTML = "";
  arr.forEach(e => {
    const tr = document.createElement("tr");
    tr.dataset.id = e.id;
    tr.innerHTML = `
      <td>${e.id}</td>
      <td>${escapeHtml(e.format||"")}</td>
      <td>${escapeHtml(e.date||"")}</td>
      <td>${e.duration ?? ""}</td>
      <td>${escapeHtml(e.notes||"")}</td>`;
    expTableBody.appendChild(tr);
  });
}

// --- setup plot config
async function setupPlotConfig(expId) {
  const resp = await fetch(`/api/experiment/${expId}/columns`);
  if (!resp.ok) { alert("Ошибка получения колонок"); return; }
  const data = await resp.json();
  const cols = data.columns;
  xSelect.innerHTML = "";
  cols.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c;
    opt.textContent = c;
    xSelect.appendChild(opt);
  });
  yCheckboxes.innerHTML = "";
  cols.forEach(c => {
    const id = "y_" + c;
    const div = document.createElement("div");
    div.innerHTML = `<label><input type="checkbox" value="${c}" id="${id}"> ${c}</label>`;
    yCheckboxes.appendChild(div);
  });
  plotConfig.classList.remove("hidden");
}

// --- draw plot
async function drawPlot(expId, xCol, yCols) {
  const resp = await fetch(`/api/experiment/${expId}/data?x=${encodeURIComponent(xCol)}&ys=${encodeURIComponent(yCols.join(","))}`);
  if (!resp.ok) { alert("Ошибка загрузки данных"); return; }
  const data = await resp.json();
  const traces = [];
  for (const [col, arr] of Object.entries(data.ys)) {
    traces.push({
      x: data.x,
      y: arr,
      mode: "lines",
      name: col
    });
  }
  Plotly.newPlot(plotArea, traces, {title: `Эксперимент ${expId}`, xaxis:{title:xCol}});
}

// --- event delegation
batTableBody.addEventListener("click", ev => {
  const tr = ev.target.closest("tr");
  if (!tr) return;
  const id = tr.dataset.id;
  selectedBattery = id;
  batteriesView.classList.add("hidden");
  experimentsView.classList.remove("hidden");
  loadExperiments(id);
});

expTableBody.addEventListener("click", ev => {
  const tr = ev.target.closest("tr");
  if (!tr) return;
  const id = tr.dataset.id;
  selectedExperiment = id;
  setupPlotConfig(id);
});

backBtn.addEventListener("click", () => {
  experimentsView.classList.add("hidden");
  batteriesView.classList.remove("hidden");
  plotConfig.classList.add("hidden");
  plotArea.innerHTML = "";
});

plotBtn.addEventListener("click", () => {
  if (!selectedExperiment) return;
  const xCol = xSelect.value;
  const yCols = [...yCheckboxes.querySelectorAll("input:checked")].map(cb => cb.value);
  if (!xCol || yCols.length === 0) { alert("Выбери X и хотя бы один Y"); return; }
  drawPlot(selectedExperiment, xCol, yCols);
});

// --- init
loadBatteries();
</script>
</body>
</html>
